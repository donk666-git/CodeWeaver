<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CodeWeaver Pro</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

    <style>
        body { font-family: "Segoe UI", sans-serif; background-color: #f8f9fa; font-size: 13px; }
        .project-card { border: 1px solid #e1e4e8; border-radius: 6px; margin-bottom: 12px; background: #fff; overflow:hidden; }
        .project-header { background: #f6f8fa; border-bottom: 1px solid #e1e4e8; padding: 8px 12px; font-weight: 600; color: #24292f; display: flex; justify-content: space-between; align-items: center; }
        .snippet-item { padding: 8px 12px; border-bottom: 1px solid #eaecef; display: flex; justify-content: space-between; align-items: center; }
        .snippet-item:hover { background: #f1f8ff; }
        .snippet-title { font-weight: 500; cursor: pointer; color: #0366d6; max-width: 130px; }
        .snippet-title:hover { text-decoration: underline; }
        .btn-action { border: none; background: none; font-size: 14px; padding: 2px 6px; opacity: 0.6; }
        .btn-action:hover { opacity: 1; transform: scale(1.1); }
        .btn-del-proj { color: #cf222e; font-size: 12px; border: 1px solid transparent; padding: 2px 6px; border-radius: 4px; }
        .btn-del-proj:hover { border-color: #cf222e; background: #fff; }
        textarea { font-family: Consolas, monospace; font-size: 11px; }
    </style>
</head>
<body class="p-3">

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" id="editor-tab" data-bs-toggle="tab" data-bs-target="#editor">ğŸ–Šï¸ ç¼–è¾‘å™¨</button></li>
        <li class="nav-item"><button class="nav-link" id="library-tab" data-bs-toggle="tab" data-bs-target="#library" onclick="loadSnippets()">ğŸ“š é¡¹ç›®åº“</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="editor">
            <div class="row g-2 mb-2">
                <div class="col-6"><input type="text" id="inputProject" class="form-control form-control-sm" placeholder="ğŸ“‚ é¡¹ç›®å"></div>
                <div class="col-6"><input type="text" id="inputTitle" class="form-control form-control-sm" placeholder="ğŸ“ æ ‡é¢˜"></div>
            </div>
            <div class="mb-2">
                <select id="langSelect" class="form-select form-select-sm">
                    <option value="auto">âœ¨ è‡ªåŠ¨æ£€æµ‹</option>
                    <option value="python">Python</option>
                    <option value="matlab">MATLAB</option>
                    <option value="c">C / C++</option>
                </select>
            </div>
            <div class="mb-3 position-relative">
                <textarea id="codeSource" class="form-control" rows="12" placeholder="// ä»£ç ..."></textarea>
                <button type="button" class="btn btn-sm btn-light border position-absolute bottom-0 end-0 m-2" onclick="getFromSelection()">ğŸ“¥ å¸å–</button>
            </div>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" onclick="insertHighlight()">âš¡ æ’å…¥é«˜äº®</button>
                <button type="button" class="btn btn-success" onclick="saveSnippet()">ğŸ’¾ ä¿å­˜</button>
            </div>
            <div id="statusMsg" class="mt-2 text-center small text-muted"></div>
        </div>

        <div class="tab-pane fade" id="library">
            <div class="d-flex justify-content-between mb-2">
                <input type="text" id="searchBox" class="form-control form-control-sm me-2" placeholder="æœç´¢...">
                <button class="btn btn-sm btn-outline-primary" onclick="loadSnippets()">ğŸ”„</button>
            </div>
            <div id="gistContainer"></div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title fw-bold">âš ï¸ ç¡®è®¤åˆ é™¤</h6>
                </div>
                <div class="modal-body py-3" id="confirmMsg">...</div>
                <div class="modal-footer py-1">
                    <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-sm btn-danger" id="btnConfirmDelete">åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰è¦åˆ é™¤çš„å¯¹è±¡
        let deleteTarget = null; // { type: 'snippet'|'project', id: ..., name: ... }
        let confirmModal = null;

        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                $(document).ready(function () {
                    syncProjectName();
                    loadSnippets();
                    
                    // åˆå§‹åŒ– Modal
                    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                    
                    // ç»‘å®š Modal çš„ç¡®è®¤æŒ‰é’®
                    $('#btnConfirmDelete').click(performDelete);

                    // æœç´¢é€»è¾‘
                    $('#searchBox').on('keyup', function() {
                        var val = $(this).val().toLowerCase();
                        $(".snippet-item").each(function() {
                            $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1);
                        });
                    });
                });
            }
        });

        function showStatus(msg, type='info') {
            const color = type === 'error' ? 'text-danger' : 'text-success';
            $('#statusMsg').html(`<span class="${color}">${msg}</span>`);
            setTimeout(() => $('#statusMsg').empty(), 3000);
        }

        function syncProjectName() {
            try {
                const url = Office.context.document.url;
                if (url) {
                    let filename = url.substring(url.lastIndexOf('/') + 1);
                    if (filename.indexOf('.') > -1) filename = filename.substring(0, filename.lastIndexOf('.'));
                    filename = decodeURIComponent(filename);
                    if (filename) $('#inputProject').val(filename);
                } else {
                    const last = localStorage.getItem("last_project");
                    if(last) $('#inputProject').val(last);
                }
            } catch (e) {}
        }

        // --- ä¿å­˜ ---
        window.saveSnippet = async function() {
            const code = $('#codeSource').val();
            const project = $('#inputProject').val() || "é»˜è®¤";
            const title = $('#inputTitle').val();
            if (!code || !title) return showStatus("âŒ è¯·å¡«å†™ä»£ç å’Œæ ‡é¢˜", "error");
            localStorage.setItem("last_project", project);

            try {
                showStatus("â³ ä¿å­˜ä¸­...");
                const res = await fetch('/api/snippets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project, title, code, language: $('#langSelect').val() })
                });
                if ((await res.json()).status === 'success') {
                    showStatus("âœ… æˆåŠŸ", "success");
                    $('#inputTitle').val('');
                    loadSnippets();
                } else showStatus("âŒ å¤±è´¥", "error");
            } catch (e) { showStatus("âŒ é”™è¯¯", "error"); }
        };

        // --- åŠ è½½åˆ—è¡¨ ---
        window.loadSnippets = async function() {
            try {
                const res = await fetch('/api/snippets?t=' + Date.now());
                const grouped = await res.json();
                const $cont = $('#gistContainer');
                $cont.empty();

                if (Object.keys(grouped).length === 0) {
                    $cont.html('<div class="text-center text-muted mt-4">æš‚æ— ä»£ç </div>');
                    return;
                }

                for (const [projName, items] of Object.entries(grouped)) {
                    // è½¬ä¹‰
                    const safeProj = projName.replace(/"/g, '&quot;');
                    
                    let html = `
                        <div class="project-card">
                            <div class="project-header">
                                <span>ğŸ“‚ ${projName}</span>
                                <button class="btn-del-proj" onclick="askDeleteProject('${safeProj}')">åˆ é™¤æ–‡ä»¶å¤¹</button>
                            </div>
                            <div>
                    `;
                    items.forEach(item => {
                        const safeCode = encodeURIComponent(item.code);
                        const safeTitle = item.title.replace(/"/g, '&quot;');
                        html += `
                            <div class="snippet-item">
                                <span class="snippet-title text-truncate" onclick="loadToEditor('${safeCode}', '${item.language}')">${item.title}</span>
                                <div>
                                    <button class="btn-action btn-locate" onclick="locateInDoc('${safeCode}')">ğŸ”</button>
                                    <button class="btn-action btn-delete" style="color:#cf222e;" onclick="askDeleteSnippet(${item.id}, '${safeTitle}')">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                    $cont.append(html);
                }
            } catch (e) {}
        };

        // --- æ ¸å¿ƒï¼šä»£æ›¿ confirm çš„æ¨¡æ€æ¡†é€»è¾‘ ---
        
        // 1. è§¦å‘åˆ é™¤ Snippet
        window.askDeleteSnippet = function(id, title) {
            deleteTarget = { type: 'snippet', id: id };
            $('#confirmMsg').text(`ç¡®è®¤åˆ é™¤ä»£ç  "${title}" å—ï¼Ÿ`);
            confirmModal.show();
        };

        // 2. è§¦å‘åˆ é™¤ Project
        window.askDeleteProject = function(name) {
            deleteTarget = { type: 'project', name: name };
            $('#confirmMsg').html(`ç¡®è®¤åˆ é™¤æ–‡ä»¶å¤¹ <b>"${name}"</b> å—ï¼Ÿ<br><small class="text-danger">è¿™å°†åˆ é™¤é‡Œé¢çš„æ‰€æœ‰ä»£ç ï¼</small>`);
            confirmModal.show();
        };

        // 3. æ‰§è¡Œåˆ é™¤
        async function performDelete() {
            if (!deleteTarget) return;
            confirmModal.hide(); // å…³å¼¹çª—

            let url = '', method = '';
            let body = null;

            if (deleteTarget.type === 'snippet') {
                url = '/api/snippets/' + deleteTarget.id;
                method = 'DELETE';
            } else if (deleteTarget.type === 'project') {
                url = '/api/projects/delete';
                method = 'POST';
                body = JSON.stringify({ name: deleteTarget.name });
            }

            try {
                const opts = { method: method, headers: {'Content-Type': 'application/json'} };
                if(body) opts.body = body;
                
                const res = await fetch(url, opts);
                const data = await res.json();
                
                if (data.status === 'success') {
                    loadSnippets(); // åˆ·æ–°
                } else {
                    alert("åˆ é™¤å¤±è´¥");
                }
            } catch (e) { alert("ç½‘ç»œé”™è¯¯"); }
        }

        // --- å…¶ä»–å·¥å…· ---
        window.loadToEditor = function(enc, lang) {
            $('#codeSource').val(decodeURIComponent(enc));
            $('#langSelect').val(lang);
            new bootstrap.Tab('#editor-tab').show();
        };

        window.locateInDoc = async function(enc) {
            const code = decodeURIComponent(enc).substring(0, 50).trim();
            try {
                await Word.run(async (ctx) => {
                    const r = ctx.document.body.search(code, { matchCase: true });
                    ctx.load(r);
                    await ctx.sync();
                    if (r.items.length > 0) r.items[0].select();
                });
            } catch(e){}
        };

        window.insertHighlight = async function() {
            const code = $('#codeSource').val();
            const lang = $('#langSelect').val();
            if (!code) return showStatus("âŒ ä»£ç ä¸ºç©º", "error");
            try {
                const res = await fetch('/api/render', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code, language: lang})
                });
                const data = await res.json();
                if(data.status === 'success') {
                    await Word.run(async (ctx) => {
                        ctx.document.getSelection().insertHtml(data.html, "Replace");
                        await ctx.sync();
                    });
                } else showStatus("âŒ æ¸²æŸ“å¤±è´¥", "error");
            } catch(e) {}
        };

        window.getFromSelection = async function() {
            try {
                await Word.run(async (ctx) => {
                    const r = ctx.document.getSelection();
                    r.load("text");
                    await ctx.sync();
                    if(r.text) $('#codeSource').val(r.text);
                });
            } catch(e){}
        };
    </script>
</body>
</html>